<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:pageModels="clr-namespace:SolarLab.AdvertBoard.Mobile.Presentation.PageModels"
             xmlns:f="clr-namespace:Fonts"
             x:Class="SolarLab.AdvertBoard.Mobile.Presentation.Pages.AdvertDetailsPage"
            
             Title="Объявление"
             BackgroundColor="{AppThemeBinding Light={StaticResource LightBackground}, Dark={StaticResource DarkBackground}}">

    <ScrollView>
        <VerticalStackLayout Spacing="16" Padding="16">

            <!-- Заголовок -->
            <Label Text="{Binding Advert.Title}" Style="{StaticResource Title1}" LineBreakMode="TailTruncation"/>

            <!-- Галерея изображений -->
            <CarouselView ItemsSource="{Binding AdvertImages}" HeightRequest="280" HorizontalScrollBarVisibility="Never" IndicatorView="{x:Reference carouselIndicator}">
                <CarouselView.ItemTemplate>
                    <DataTemplate>
                        <Border StrokeThickness="0" StrokeShape="RoundRectangle 16" Padding="0">
                            <Border.Shadow>
                                <Shadow Brush="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Black}}"
                                        Opacity="0.15" Offset="0,4" Radius="12"/>
                            </Border.Shadow>
                            <Image Source="{Binding .}" Aspect="AspectFill" HeightRequest="280" BackgroundColor="{AppThemeBinding Light={StaticResource LightSecondaryBackground}, Dark={StaticResource DarkSecondaryBackground}}"/>
                        </Border>
                    </DataTemplate>
                </CarouselView.ItemTemplate>
            </CarouselView>
            <IndicatorView x:Name="carouselIndicator" HorizontalOptions="Center" Margin="0,-24,0,0"/>

            <!-- Цена и категория -->
            <Border Background="{AppThemeBinding Light={StaticResource LightSecondaryBackground}, Dark={StaticResource DarkSecondaryBackground}}"
                    StrokeThickness="0" Padding="16" StrokeShape="RoundRectangle 12">
                <Border.Shadow>
                    <Shadow Brush="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Black}}" Opacity="0.10" Offset="0,4" Radius="10"/>
                </Border.Shadow>
                <VerticalStackLayout Spacing="4">
                    <Label Text="{Binding Advert.Price, StringFormat='{0:C0}'}" Style="{StaticResource Title2}" TextColor="{StaticResource Primary}"/>
                    <Label Text="{Binding Advert.CategoryTitle}" Style="{StaticResource Body1}" TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"/>
                </VerticalStackLayout>
            </Border>

            <!-- Описание -->
            <Border Background="{AppThemeBinding Light={StaticResource LightSecondaryBackground}, Dark={StaticResource DarkSecondaryBackground}}"
                    StrokeThickness="0" Padding="16" StrokeShape="RoundRectangle 12">
                <Border.Shadow>
                    <Shadow Brush="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Black}}" Opacity="0.10" Offset="0,4" Radius="10"/>
                </Border.Shadow>
                <VerticalStackLayout Spacing="8">
                    <Label Text="Описание" Style="{StaticResource Body1Strong}" />
                    <Label Text="{Binding Advert.Description}" Style="{StaticResource Body1}" LineBreakMode="WordWrap"/>
                </VerticalStackLayout>
            </Border>

            <!-- Контакты продавца -->
            <Border Background="{AppThemeBinding Light={StaticResource LightSecondaryBackground}, Dark={StaticResource DarkSecondaryBackground}}"
                    StrokeThickness="0" Padding="16" StrokeShape="RoundRectangle 12">
                <Border.Shadow>
                    <Shadow Brush="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Black}}" Opacity="0.10" Offset="0,4" Radius="10"/>
                </Border.Shadow>
                <VerticalStackLayout Spacing="12">
                    <Label Text="Контакты продавца" Style="{StaticResource Title3}" />

                    <!-- Полное имя -->
                    <HorizontalStackLayout Spacing="8">
                        <Image Source="{x:Static f:FluentUI.person_24_regular}" HeightRequest="20" WidthRequest="20"/>
                        <Label Text="{Binding Advert.AuthorContacts.FullName}" Style="{StaticResource Body1}"/>
                    </HorizontalStackLayout>

                    <!-- Email -->
                    <HorizontalStackLayout Spacing="8">
                        <Image Source="{x:Static f:FluentUI.mail_24_regular}" HeightRequest="20" WidthRequest="20"/>
                        <Label Text="{Binding Advert.AuthorContacts.ContactEmail}" Style="{StaticResource Body1Strong}" TextColor="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource Primary}}">
                            <Label.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding EmailCommand}" CommandParameter="{Binding Advert.AuthorContacts.ContactEmail}"/>
                            </Label.GestureRecognizers>
                        </Label>
                    </HorizontalStackLayout>

                    <!-- Телефон -->
                    <HorizontalStackLayout Spacing="8">
                        <Image Source="{x:Static f:FluentUI.call_24_regular}" HeightRequest="20" WidthRequest="20"/>
                        <Label Text="{Binding Advert.AuthorContacts.PhoneNumber}" Style="{StaticResource Body1Strong}" TextColor="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource Primary}}">
                            <Label.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding CallCommand}" CommandParameter="{Binding Advert.AuthorContacts.PhoneNumber}"/>
                            </Label.GestureRecognizers>
                        </Label>
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Border>

            <!-- Комментарии -->
            <HorizontalStackLayout HorizontalOptions="Fill" Spacing="10">
                <Label Text="{Binding Advert.CommentsCount, StringFormat='Комментариев: {0}'}" Style="{StaticResource Title3}" VerticalOptions="Center"/>
                <Button Text="{Binding ToggleCommentsButtonText}" Command="{Binding ToggleCommentsCommand}" IsVisible="{Binding ShowToggleCommentsButton}" Style="{StaticResource SecondaryButton}" HorizontalOptions="End"/>
            </HorizontalStackLayout>

            <CollectionView ItemsSource="{Binding Comments}" IsVisible="{Binding CommentsVisible}" Margin="0,8,0,0">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border StrokeShape="RoundRectangle 10" StrokeThickness="1" Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray700}}" Padding="12" Margin="0,4" BackgroundColor="{AppThemeBinding Light={StaticResource LightSecondaryBackground}, Dark={StaticResource DarkTertiaryBackground}}">
                            <VerticalStackLayout Spacing="4">
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="{Binding FullName}" Style="{StaticResource Body2Strong}"/>
                                    <Label Text="{Binding CreatedAt, StringFormat='{0:dd.MM.yyyy HH:mm}'}" Style="{StaticResource Caption}" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"/>
                                </HorizontalStackLayout>
                                <Label Text="{Binding Text}" Style="{StaticResource Body2}" LineBreakMode="WordWrap"/>
                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Кнопка добавить комментарий -->
            <Button Text="Добавить комментарий" Command="{Binding AddCommentCommand}" Margin="0,8,0,16" IsVisible="{Binding AddCommentVisible}" Style="{StaticResource PrimaryButton}"/>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
